# 指定 CMake 最低版本要求（OpenVINO 2025.3 需要至少 3.13）
cmake_minimum_required(VERSION 3.13)

# 定义项目基本信息：名称、版本、描述、使用语言
project(OpenVINO_SEG_Inference
        VERSION 1.0.0
        DESCRIPTION "YOLO OpenVINO SEG Inference Engine"
        LANGUAGES CXX
        )

# === 强制 Release 构建（仅对单配置生成器生效，如 Make/Ninja）===
if(NOT CMAKE_CONFIGURATION_TYPES)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
    if(NOT CMAKE_BUILD_TYPE)
        set(CMAKE_BUILD_TYPE Release CACHE STRING "Choose the type of build." FORCE)
    endif()
endif()

# 设置 C++20 标准并禁用扩展
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# === 平台相关处理：macOS SDK 路径（可选，用于修复某些 CI 环境头文件缺失）===
if(APPLE)
    find_program(XCRUN_EXECUTABLE xcrun)
    if(XCRUN_EXECUTABLE)
        execute_process(
                COMMAND ${XCRUN_EXECUTABLE} --show-sdk-path
                OUTPUT_VARIABLE CMAKE_OSX_SYSROOT
                OUTPUT_STRIP_TRAILING_WHITESPACE
        )
        if(CMAKE_OSX_SYSROOT AND EXISTS "${CMAKE_OSX_SYSROOT}/usr/include")
            include_directories(SYSTEM "${CMAKE_OSX_SYSROOT}/usr/include")
        endif()
    endif()
endif()

# === 自动下载并集成 nlohmann/json（header-only JSON 库）===
include(FetchContent)

FetchContent_Declare(
        json
        GIT_REPOSITORY https://github.com/nlohmann/json.git
        GIT_TAG        v3.11.3  # 可根据需要更新为 v3.12.0 等
)

FetchContent_MakeAvailable(json)

# === 查找 OpenVINO（允许用户通过 -DOpenVINO_DIR 指定路径）===
find_package(OpenVINO 2025.3 REQUIRED COMPONENTS Runtime)

# === 查找 OpenCV ===
find_package(OpenCV REQUIRED)

# === 添加本地头文件目录 ===
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/include)

# === 定义可执行文件 ===
add_executable(openvino_seg_inference
        src/main.cpp
        src/yolo_openVino.cpp
        src/base64.cpp
        )

# === 链接所有依赖库 ===
target_link_libraries(openvino_seg_inference
        openvino::runtime
        ${OpenCV_LIBS}
        nlohmann_json::nlohmann_json  # 自动设置 include 路径
        )

# === 设置输出目录 ===
set_target_properties(openvino_seg_inference PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        )

# === 打印构建信息 ===
message(STATUS "✅ OpenVINO 版本: ${OpenVINO_VERSION}")
message(STATUS "✅ OpenCV 版本: ${OpenCV_VERSION}")
if(CMAKE_CONFIGURATION_TYPES)
    message(STATUS "✅ 构建系统: 多配置（如 Visual Studio / Xcode）")
else()
    message(STATUS "✅ 构建类型: ${CMAKE_BUILD_TYPE}")
endif()
message(STATUS "✅ nlohmann/json 已集成（v3.11.3）")
message(STATUS "✅ 输出路径: ${CMAKE_BINARY_DIR}/bin")
